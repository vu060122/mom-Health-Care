<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>媽媽照護日誌</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-pink': '#fff0f5',
                        'rose-btn': '#e11d48',
                        'teal-btn': '#2dd4bf', 
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.2rem',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #fff1f2;
            -webkit-tap-highlight-color: transparent;
            color: #374151;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .input-block {
            width: 100%;
            padding: 0.8rem 0.5rem;
            border-radius: 0.5rem;
            background-color: #f3f4f6;
            border: none;
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .input-block:focus { outline: 2px solid #fbcfe8; background-color: white; }

        .input-outline {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background-color: white;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        .input-outline:focus { outline: none; border-color: #f472b6; ring: 1px solid #f472b6; }

        .btn-main {
            width: 100%;
            padding: 0.8rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            font-size: 1rem;
            margin-top: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-item-active {
            background-color: #fce7f3;
            color: #be185d;
        }
        .nav-item-inactive {
            color: #6b7280;
        }

        .edit-mode-border {
            border: 2px solid #f59e0b !important;
            background-color: #fffbeb !important;
        }
        .edit-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Helper Functions ---
        const formatDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return d.toISOString().split('T')[0];
        };
        const formatDateCN = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        };
        const addDays = (dateStr, days) => {
            if (!dateStr) return '';
            const result = new Date(dateStr);
            result.setDate(result.getDate() + parseInt(days));
            return formatDate(result);
        };
        const diffDays = (date1, date2) => {
            if (!date1 || !date2) return 0;
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round(Math.abs((new Date(date1) - new Date(date2)) / oneDay));
        };
        const addMonths = (dateStr, months) => {
            if (!dateStr) return '';
            const result = new Date(dateStr);
            result.setMonth(result.getMonth() + parseInt(months));
            return formatDate(result);
        };
        const calculateRadioEndDate = (startDate, sessions) => {
            if (!startDate || !sessions) return '';
            let current = new Date(startDate);
            let sessionsRemaining = parseInt(sessions) - 1;
            while (sessionsRemaining > 0) {
                current.setDate(current.getDate() + 1);
                const day = current.getDay();
                if (day !== 0 && day !== 6) sessionsRemaining--;
            }
            return formatDate(current);
        };

        // --- Shared Components ---
        const NavIcon = ({ active, label, icon, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center py-2 px-1 rounded-lg transition-colors duration-200 w-full ${active ? 'nav-item-active font-bold' : 'nav-item-inactive'}`}>
                <i className={`fas ${icon} text-lg mb-1`}></i>
                <span className="text-[10px] leading-none">{label}</span>
            </button>
        );

        const SectionTitle = ({ title, colorClass, isEditing, onCancel }) => (
            <div className="flex justify-between items-center mb-4">
                <h3 className={`font-bold text-lg flex items-center ${colorClass}`}>
                    {isEditing ? <span className="text-amber-600 mr-2 edit-badge"><i className="fas fa-pen-to-square"></i> 編輯中...</span> : <span><i className="fas fa-plus mr-2 text-sm"></i> {title}</span>}
                </h3>
                {isEditing && (
                    <button onClick={onCancel} className="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-300">
                        取消編輯
                    </button>
                )}
            </div>
        );

        const ActionButtons = ({ isEditing, onEdit, onDelete }) => (
            <div className="absolute top-3 right-3 flex gap-2 z-10 bg-white/80 rounded-lg pl-1 backdrop-blur-sm">
                <button onClick={(e) => {e.stopPropagation(); onEdit();}} className="text-blue-400 hover:text-blue-600 p-1.5"><i className="fas fa-pen"></i></button>
                <button onClick={(e) => {e.stopPropagation(); onDelete();}} className="text-gray-400 hover:text-red-500 p-1.5"><i className="fas fa-trash"></i></button>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('treatment');
            const [searchTerm, setSearchTerm] = useState('');
            
            // Data States
            const [treatments, setTreatments] = useState([]);
            const [symptoms, setSymptoms] = useState([]);
            const [clinicVisits, setClinicVisits] = useState([]);
            const [boneTeeth, setBoneTeeth] = useState([]);
            const [radios, setRadios] = useState([]);
            const [reports, setReports] = useState([]);
            const [departments, setDepartments] = useState(['胸腔內科', '皮膚科', '眼科', '骨科-台大', '骨科-慈濟']);

            useEffect(() => {
                const load = (k, s) => { const d = localStorage.getItem(`momApp_${k}`); if(d) s(JSON.parse(d)); };
                load('treatments', setTreatments); load('symptoms', setSymptoms); load('clinicVisits', setClinicVisits);
                load('boneTeeth', setBoneTeeth); load('radios', setRadios); load('reports', setReports); load('departments', setDepartments);
            }, []);

            const update = (key, data, setter) => { setter(data); localStorage.setItem(`momApp_${key}`, JSON.stringify(data)); };
            
            const saveItem = (list, setter, key, item, id = null) => {
                let newList;
                if (id) {
                    newList = list.map(i => i.id === id ? { ...item, id } : i);
                } else {
                    newList = [{ id: Date.now(), ...item }, ...list];
                }
                newList.sort((a,b) => new Date(b.date) - new Date(a.date));
                update(key, newList, setter);
            };

            const del = (list, setter, key, id) => { 
                // Using setTimeout to ensure confirm doesn't block UI rendering updates immediately
                setTimeout(() => {
                    if(confirm('確定要刪除這筆紀錄嗎？此動作無法復原。')) {
                        update(key, list.filter(i => i.id !== id), setter);
                    }
                }, 10);
            };

            const renderContent = () => {
                const props = { term: searchTerm };
                switch(activeTab) {
                    case 'treatment': return <TreatmentTab data={treatments} onSave={(i, id) => saveItem(treatments, setTreatments, 'treatments', i, id)} onDelete={id => del(treatments, setTreatments, 'treatments', id)} {...props} />;
                    case 'symptoms': return <SymptomTab data={symptoms} onSave={(i, id) => saveItem(symptoms, setSymptoms, 'symptoms', i, id)} onDelete={id => del(symptoms, setSymptoms, 'symptoms', id)} {...props} />;
                    case 'clinic': return <ClinicTab data={clinicVisits} depts={departments} setDepts={d => update('departments', d, setDepartments)} onSave={(i, id) => saveItem(clinicVisits, setClinicVisits, 'clinicVisits', i, id)} onDelete={id => del(clinicVisits, setClinicVisits, 'clinicVisits', id)} {...props} />;
                    case 'bone': return <BoneTeethTab data={boneTeeth} onSave={(i, id) => saveItem(boneTeeth, setBoneTeeth, 'boneTeeth', i, id)} onDelete={id => del(boneTeeth, setBoneTeeth, 'boneTeeth', id)} {...props} />;
                    case 'radio': return <RadioTab data={radios} onSave={(i, id) => saveItem(radios, setRadios, 'radios', i, id)} onDelete={id => del(radios, setRadios, 'radios', id)} {...props} />;
                    case 'report': return <ReportTab data={reports} onSave={(i, id) => saveItem(reports, setReports, 'reports', i, id)} onDelete={id => del(reports, setReports, 'reports', id)} {...props} />;
                    default: return null;
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fff1f2] pb-10">
                    <div className="bg-white sticky top-0 z-50 shadow-sm border-b border-gray-100">
                        <div className="grid grid-cols-6 gap-1 px-1 py-2">
                            <NavIcon label="主治療" icon="fa-heart-pulse" active={activeTab === 'treatment'} onClick={() => setActiveTab('treatment')} />
                            <NavIcon label="症狀記事" icon="fa-calendar-check" active={activeTab === 'symptoms'} onClick={() => setActiveTab('symptoms')} />
                            <NavIcon label="各科門診" icon="fa-stethoscope" active={activeTab === 'clinic'} onClick={() => setActiveTab('clinic')} />
                            <NavIcon label="保骨/牙" icon="fa-bone" active={activeTab === 'bone'} onClick={() => setActiveTab('bone')} />
                            <NavIcon label="放療" icon="fa-bolt" active={activeTab === 'radio'} onClick={() => setActiveTab('radio')} />
                            <NavIcon label="檢查報告" icon="fa-file-medical" active={activeTab === 'report'} onClick={() => setActiveTab('report')} />
                        </div>
                    </div>
                    <div className="px-4 py-3 bg-[#fff1f2]">
                        <div className="relative">
                            <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" placeholder="搜尋紀錄..." className="w-full pl-10 pr-4 py-3 rounded-full border-2 border-pink-100 bg-white focus:outline-none focus:border-pink-300 transition-colors text-sm"
                                value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                    </div>
                    <div className="px-4">{renderContent()}</div>
                </div>
            );
        };

        // --- Tabs ---

        const TreatmentTab = ({ data, onSave, onDelete, term }) => {
            const defaultForm = { date: formatDate(new Date()), type: '門診', drug: '', notes: '', admit: '', discharge: '' };
            const [form, setForm] = useState(defaultForm);
            const [editingId, setEditingId] = useState(null);
            
            const handleEdit = (item) => {
                setForm(item);
                setEditingId(item.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const handleCancel = () => { setForm(defaultForm); setEditingId(null); };

            const handleSubmit = (e) => {
                e.preventDefault();
                const nextDate = addDays(form.date, 21);
                let duration = 0;
                if(form.type === '住院' && form.date && form.discharge) duration = diffDays(form.discharge, form.date) + 1;
                onSave({ ...form, nextDate, duration }, editingId);
                handleCancel();
            };

            return (
                <div>
                    <div className={`bg-white p-5 rounded-2xl shadow-sm mb-6 ${editingId ? 'edit-mode-border' : ''}`}>
                        <SectionTitle title={editingId ? "編輯治療紀錄" : "新增治療紀錄"} colorClass="text-rose-600" isEditing={!!editingId} onCancel={handleCancel} />
                        <div className="flex gap-6 mb-4 px-2">
                            {['門診', '住院'].map(t => (
                                <label key={t} className="flex items-center cursor-pointer">
                                    <input type="radio" name="type" checked={form.type === t} onChange={() => setForm({...form, type: t})} className="mr-2" />
                                    <span className={form.type === t ? 'text-gray-900 font-bold' : 'text-gray-500'}>{t}</span>
                                </label>
                            ))}
                        </div>

                        {/* Modified Date Selection Layout */}
                        {form.type === '住院' ? (
                            <div className="flex gap-2 mb-2">
                                <div className="flex-1">
                                    <label className="text-xs text-gray-500 mb-1 block pl-1">入院日期</label>
                                    <input type="date" className="input-block text-gray-700 font-medium mb-0" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs text-gray-500 mb-1 block pl-1">出院日期</label>
                                    <input type="date" className="input-block text-gray-700 font-medium mb-0" value={form.discharge} onChange={e => setForm({...form, discharge: e.target.value})} />
                                </div>
                            </div>
                        ) : (
                            <div className="mb-2">
                                <label className="text-xs text-gray-500 mb-1 block pl-1">治療日期</label>
                                <input type="date" className="input-block text-gray-700 font-medium" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                            </div>
                        )}

                        <input type="text" placeholder="藥品名稱" className="input-outline mt-2" value={form.drug} onChange={e => setForm({...form, drug: e.target.value})} />
                        <textarea placeholder="特別事項" className="input-outline resize-none" rows="3" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}></textarea>
                        
                        <div className="mt-2 mb-2">
                            <label className="text-xs text-gray-400 mb-1 block">下次治療預計日期 (+21天)</label>
                            <div className="input-outline bg-gray-50 text-gray-500 flex items-center justify-center">
                                {form.date ? formatDateCN(addDays(form.date, 21)) : '-'}
                            </div>
                        </div>
                        <button onClick={handleSubmit} className={`btn-main ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-[#e11d48] hover:bg-[#be123c]'}`}>
                            {editingId ? '更新紀錄' : '儲存紀錄'}
                        </button>
                    </div>

                    <div className="space-y-4">
                        {data.filter(i => JSON.stringify(i).includes(term)).map(item => (
                            <div key={item.id} className={`bg-white p-4 rounded-xl shadow-sm relative border-l-4 ${editingId === item.id ? 'border-amber-400 bg-amber-50' : 'border-rose-400'}`}>
                                <ActionButtons isEditing={!!editingId} onEdit={() => handleEdit(item)} onDelete={() => onDelete(item.id)} />
                                <div className="pr-16 mb-1">
                                    <div className="text-lg font-bold text-gray-800">{formatDateCN(item.date)}</div>
                                </div>
                                <div className="flex gap-2 mb-2 flex-wrap">
                                    <span className={`px-2 py-0.5 rounded text-xs ${item.type === '住院' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'}`}>{item.type}</span>
                                    {item.drug && <span className="text-gray-600 text-sm">{item.drug}</span>}
                                    {item.type === '住院' && item.duration > 0 && <span className="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded">共 {item.duration} 天</span>}
                                </div>
                                {item.notes && <div className="text-gray-500 text-sm bg-gray-50 p-2 rounded mb-2">{item.notes}</div>}
                                <div className="text-xs text-rose-500 font-medium"><i className="fas fa-arrow-right"></i> 下次: {formatDateCN(item.nextDate)}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SymptomTab = ({ data, onSave, onDelete, term }) => {
            const defaultForm = { date: formatDate(new Date()), desc: '', severity: '一般' };
            const [form, setForm] = useState(defaultForm);
            const [editingId, setEditingId] = useState(null);
            
            const handleEdit = (item) => { setForm(item); setEditingId(item.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const handleCancel = () => { setForm(defaultForm); setEditingId(null); };

            const levels = [
                { id: '一般', label: '輕微/記事', color: 'bg-green-100 text-green-700 border-green-200' },
                { id: '中度', label: '中度不適', color: 'bg-yellow-50 text-yellow-600 border-yellow-200' },
                { id: '嚴重', label: '嚴重不適', color: 'bg-red-50 text-red-600 border-red-200' }
            ];

            const handleSubmit = () => { if(form.desc) { onSave(form, editingId); handleCancel(); } };

            return (
                <div>
                     <div className={`bg-white p-5 rounded-2xl shadow-sm mb-6 ${editingId ? 'edit-mode-border' : ''}`}>
                        <SectionTitle title={editingId ? "編輯症狀記事" : "紀錄症狀"} colorClass="text-orange-600" isEditing={!!editingId} onCancel={handleCancel} />
                        <label className="text-xs text-gray-500 mb-1 block pl-1">日期</label>
                        <input type="date" className="mb-4 w-full text-center text-xl font-bold text-gray-700 bg-gray-100 py-3 rounded-lg border-none focus:ring-2 focus:ring-orange-200" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                        <div className="flex gap-2 mb-4">
                            {levels.map(l => (
                                <button key={l.id} onClick={() => setForm({...form, severity: l.id})} className={`flex-1 py-2 text-xs font-bold rounded-lg border ${form.severity === l.id ? l.color + ' ring-2 ring-offset-1 ring-gray-200 shadow-sm' : 'bg-white text-gray-400 border-gray-200'}`}>
                                    {l.label}
                                </button>
                            ))}
                        </div>
                        <textarea placeholder="記錄症狀..." className="input-outline h-32 resize-none text-lg p-3" value={form.desc} onChange={e => setForm({...form, desc: e.target.value})}></textarea>
                        <button onClick={handleSubmit} className={`btn-main ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-[#ea580c] hover:bg-[#c2410c]'}`}>{editingId ? '更新記事' : '記錄症狀'}</button>
                    </div>
                    <div className="space-y-3">
                        {data.filter(i => JSON.stringify(i).includes(term)).map(item => (
                            <div key={item.id} className={`p-4 rounded-xl bg-white shadow-sm relative border-l-4 ${item.severity==='嚴重'?'border-red-500':item.severity==='中度'?'border-yellow-400':'border-green-400'}`}>
                                <ActionButtons isEditing={!!editingId} onEdit={() => handleEdit(item)} onDelete={() => onDelete(item.id)} />
                                {/* Add padding-right to prevent overlap with buttons */}
                                <div className="flex justify-between items-center mb-2 pr-16">
                                    <span className="font-bold text-gray-800">{formatDateCN(item.date)}</span>
                                    <span className={`text-xs px-2 py-1 rounded-full font-bold ${item.severity==='嚴重'?'bg-red-100 text-red-600':item.severity==='中度'?'bg-yellow-100 text-yellow-600':'bg-green-100 text-green-600'}`}>{item.severity}</span>
                                </div>
                                <div className="text-gray-700 whitespace-pre-wrap">{item.desc}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const BoneTeethTab = ({ data, onSave, onDelete, term }) => {
            const defaultForm = { date: formatDate(new Date()), type: '保骨針', interval: 0, nextDate: '' };
            const [form, setForm] = useState(defaultForm);
            const [editingId, setEditingId] = useState(null);

            const handleEdit = (item) => { setForm(item); setEditingId(item.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const handleCancel = () => { setForm(defaultForm); setEditingId(null); };

            const getLast = (t) => data.filter(d => d.type === t && d.id !== editingId).sort((a,b)=> new Date(b.date) - new Date(a.date))[0];
            const lastBone = getLast('保骨針');
            const lastTeeth = getLast('牙齒塗氟');

            const handleSubmit = () => {
                const interval = (lastBone && form.type === '保骨針') ? diffDays(form.date, lastBone.date) : 0;
                const nextDate = form.type === '牙齒塗氟' ? addMonths(form.date, 3) : '';
                onSave({ ...form, interval, nextDate }, editingId);
                handleCancel();
            };

            return (
                <div>
                     {!editingId && (
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <div onClick={() => setForm({...form, type: '保骨針'})} className={`p-4 rounded-xl border-2 transition-all cursor-pointer ${form.type === '保骨針' ? 'bg-blue-50 border-blue-400 shadow-md' : 'bg-white border-transparent shadow-sm'}`}>
                                <div className="text-sm text-gray-500 mb-1">保骨針</div>
                                <div className="text-xl font-bold text-blue-600">{lastBone ? lastBone.date : '無紀錄'}</div>
                                {lastBone && <div className="text-xs text-gray-400 mt-1">距今 {diffDays(new Date(), lastBone.date)} 天</div>}
                            </div>
                            <div onClick={() => setForm({...form, type: '牙齒塗氟'})} className={`p-4 rounded-xl border-2 transition-all cursor-pointer ${form.type === '牙齒塗氟' ? 'bg-cyan-50 border-cyan-400 shadow-md' : 'bg-white border-transparent shadow-sm'}`}>
                                <div className="text-sm text-gray-500 mb-1">牙齒塗氟</div>
                                <div className="text-xl font-bold text-cyan-600">{lastTeeth ? lastTeeth.date : '無紀錄'}</div>
                                 <div className="text-xs text-gray-400 mt-1">{lastTeeth ? '請新增紀錄' : '請新增紀錄'}</div>
                            </div>
                        </div>
                     )}

                    <div className={`bg-white p-5 rounded-2xl shadow-sm mb-6 ${editingId ? 'edit-mode-border' : ''}`}>
                         <SectionTitle title={editingId ? `編輯${form.type}紀錄` : `新增${form.type}紀錄`} colorClass="text-gray-700" isEditing={!!editingId} onCancel={handleCancel} />
                        <div className="flex gap-2">
                            <input type="date" className="input-block flex-1 mb-0" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                            <button onClick={handleSubmit} className={`text-white rounded-lg px-6 font-bold ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-slate-800 hover:bg-slate-700'}`}>
                                {editingId ? '更新' : '新增'}
                            </button>
                        </div>
                    </div>
                    
                    <div className="text-sm text-gray-400 mb-2 pl-2">歷史紀錄 ({form.type})</div>
                    <div className="space-y-2">
                        {data.filter(i => i.type === form.type && JSON.stringify(i).includes(term)).map(item => (
                            <div key={item.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center relative">
                                <ActionButtons isEditing={!!editingId} onEdit={() => handleEdit(item)} onDelete={() => onDelete(item.id)} />
                                <div className="pr-16">
                                    <div className="font-bold text-gray-700">{formatDateCN(item.date)}</div>
                                    <div className="text-xs text-gray-400">
                                        {item.type === '保骨針' && item.interval > 0 && `距離上次 ${item.interval} 天`}
                                        {item.type === '牙齒塗氟' && `預計下次: ${item.nextDate}`}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const RadioTab = ({ data, onSave, onDelete, term }) => {
            const defaultForm = { startDate: formatDate(new Date()), bodyPart: '', sessions: '', notes: '' };
            const [form, setForm] = useState(defaultForm);
            const [editingId, setEditingId] = useState(null);

            const endDate = useMemo(() => calculateRadioEndDate(form.startDate, form.sessions), [form.startDate, form.sessions]);
            
            const handleEdit = (item) => { setForm(item); setEditingId(item.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const handleCancel = () => { setForm(defaultForm); setEditingId(null); };

            return (
                <div>
                     <div className={`bg-white p-5 rounded-2xl shadow-sm mb-6 border-t-4 border-purple-500 ${editingId ? 'edit-mode-border' : ''}`}>
                        <SectionTitle title={editingId ? "編輯放療療程" : "新增放療療程"} colorClass="text-purple-700" isEditing={!!editingId} onCancel={handleCancel} />
                        <div className="flex gap-3 mb-3">
                            <input type="text" placeholder="治療部位" className="input-outline mb-0 flex-1" value={form.bodyPart} onChange={e => setForm({...form, bodyPart: e.target.value})} />
                            <input type="number" placeholder="次數" className="input-outline mb-0 w-24 text-center" value={form.sessions} onChange={e => setForm({...form, sessions: e.target.value})} />
                        </div>
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">開始日期</label>
                                <input type="date" className="input-block text-sm" value={form.startDate} onChange={e => setForm({...form, startDate: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400 block mb-1">預計結束</label>
                                <div className="input-block bg-white border border-gray-100 text-purple-600 font-bold text-sm h-[46px] flex items-center justify-center">
                                    {endDate || '-'}
                                </div>
                            </div>
                        </div>
                        <textarea placeholder="副作用/記事" className="input-outline" rows="2" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}></textarea>
                        <button onClick={() => {onSave({...form, endDate}, editingId); handleCancel();}} className={`btn-main ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-[#a855f7] hover:bg-[#9333ea]'}`}>
                            {editingId ? '更新療程' : '儲存療程'}
                        </button>
                    </div>
                    <div className="space-y-3">
                        {data.filter(i => JSON.stringify(i).includes(term)).map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm relative border-l-4 border-purple-300">
                                <ActionButtons isEditing={!!editingId} onEdit={() => handleEdit(item)} onDelete={() => onDelete(item.id)} />
                                <div className="pr-16">
                                    <div className="font-bold text-lg text-purple-900">{item.bodyPart} <span className="text-sm font-normal text-gray-500">({item.sessions}次)</span></div>
                                </div>
                                <div className="text-sm text-gray-600 mt-1"><i className="far fa-clock"></i> {item.startDate} ~ {item.endDate}</div>
                                {item.notes && <div className="mt-2 text-sm text-gray-500 bg-gray-50 p-2 rounded">{item.notes}</div>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ClinicTab = ({ data, depts, setDepts, onSave, onDelete, term }) => {
            const defaultForm = { date: formatDate(new Date()), dept: depts[0], record: '' };
            const [form, setForm] = useState(defaultForm);
            const [editingId, setEditingId] = useState(null);
            const [isAddingDept, setIsAddingDept] = useState(false);
            const [newDept, setNewDept] = useState('');

            const handleEdit = (item) => { setForm(item); setEditingId(item.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const handleCancel = () => { setForm(defaultForm); setEditingId(null); };
            const handleAddDept = () => { if(newDept && !depts.includes(newDept)) { setDepts([...depts, newDept]); setForm({...form, dept: newDept}); setIsAddingDept(false); setNewDept(''); } };

            return (
                <div>
                    <div className={`bg-white p-5 rounded-2xl shadow-sm mb-6 border-t-4 border-teal-500 ${editingId ? 'edit-mode-border' : ''}`}>
                         <SectionTitle title={editingId ? "編輯門診紀錄" : "新增門診紀錄"} colorClass="text-teal-700" isEditing={!!editingId} onCancel={handleCancel} />
                        <div className="mb-3">
                            <input type="date" className="input-block font-bold text-lg" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                        </div>
                        {isAddingDept ? (
                             <div className="flex gap-2 mb-3">
                                <input type="text" placeholder="輸入科別名稱" className="input-outline mb-0" value={newDept} onChange={e => setNewDept(e.target.value)} />
                                <button onClick={handleAddDept} className="bg-teal-500 text-white px-4 rounded-lg">OK</button>
                                <button onClick={() => setIsAddingDept(false)} className="text-gray-400 px-2"><i className="fas fa-times"></i></button>
                            </div>
                        ) : (
                            <div className="flex gap-2 mb-3">
                                <select className="input-outline mb-0 flex-1 appearance-none" value={form.dept} onChange={e => setForm({...form, dept: e.target.value})}>
                                    {depts.map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                                <button onClick={() => setIsAddingDept(true)} className="border border-teal-200 text-teal-500 rounded-lg w-12 flex items-center justify-center hover:bg-teal-50"><i className="fas fa-plus"></i></button>
                            </div>
                        )}
                        <textarea placeholder="診療紀錄/醫囑" className="input-outline h-24" value={form.record} onChange={e => setForm({...form, record: e.target.value})}></textarea>
                        <button onClick={() => { onSave(form, editingId); handleCancel(); }} className={`btn-main ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-[#2dd4bf] hover:bg-[#14b8a6]'}`}>
                            {editingId ? '更新紀錄' : '儲存紀錄'}
                        </button>
                    </div>
                    <div className="space-y-3">
                         {data.filter(i => JSON.stringify(i).includes(term)).map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm relative">
                                <ActionButtons isEditing={!!editingId} onEdit={() => handleEdit(item)} onDelete={() => onDelete(item.id)} />
                                <div className="flex items-center gap-2 mb-2 pr-16">
                                    <span className="bg-teal-50 text-teal-700 px-2 py-1 rounded text-xs font-bold">{item.dept}</span>
                                    <span className="font-bold text-gray-700">{formatDateCN(item.date)}</span>
                                </div>
                                <div className="text-gray-600 text-sm whitespace-pre-wrap pl-1 border-l-2 border-gray-200">{item.record}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ReportTab = ({ data, onSave, onDelete, term }) => {
            const defaultForm = { date: formatDate(new Date()), item: '', text: '', trans: '' };
            const [form, setForm] = useState(defaultForm);
            const [editingId, setEditingId] = useState(null);

            const handleEdit = (item) => { setForm(item); setEditingId(item.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const handleCancel = () => { setForm(defaultForm); setEditingId(null); };

            return (
                <div>
                     <div className={`bg-white p-5 rounded-2xl shadow-sm mb-6 border-t-4 border-slate-500 ${editingId ? 'edit-mode-border' : ''}`}>
                        <SectionTitle title={editingId ? "編輯檢查報告" : "新增檢查報告"} colorClass="text-slate-700" isEditing={!!editingId} onCancel={handleCancel} />
                        <input type="date" className="input-block mb-2" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                        <input type="text" placeholder="檢查項目 (如: CT)" className="input-outline" value={form.item} onChange={e => setForm({...form, item: e.target.value})} />
                        <textarea placeholder="原文報告..." className="input-outline font-mono text-sm h-24" value={form.text} onChange={e => setForm({...form, text: e.target.value})}></textarea>
                        <textarea placeholder="中文翻譯..." className="input-outline h-24" value={form.trans} onChange={e => setForm({...form, trans: e.target.value})}></textarea>
                        <div className="flex justify-end mb-3">
                            <a href={`https://translate.google.com/?sl=auto&tl=zh-TW&text=${encodeURIComponent(form.text)}`} target="_blank" className="text-xs text-blue-500 underline">去 Google 翻譯</a>
                        </div>
                        <button onClick={() => { onSave(form, editingId); handleCancel(); }} className={`btn-main ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-slate-600 hover:bg-slate-700'}`}>
                            {editingId ? '更新報告' : '儲存報告'}
                        </button>
                    </div>
                    <div className="space-y-4">
                         {data.filter(i => JSON.stringify(i).includes(term)).map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm relative">
                                <ActionButtons isEditing={!!editingId} onEdit={() => handleEdit(item)} onDelete={() => onDelete(item.id)} />
                                <div className="font-bold text-slate-700 mb-1 pr-16">{item.item}</div>
                                <div className="text-xs text-gray-400 mb-2">{item.date}</div>
                                <div className="bg-gray-50 p-2 rounded text-xs font-mono text-gray-600 mb-2">{item.text}</div>
                                {item.trans && <div className="bg-blue-50 p-2 rounded text-xs text-gray-700">{item.trans}</div>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

